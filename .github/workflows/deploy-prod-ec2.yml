name: Deploy to Production (EC2)

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:

env:
  AWS_REGION: us-west-2
  ENVIRONMENT: prod
  DOCKER_USERNAME: mx0100 # æ‚¨çš„Docker Hubç”¨æˆ·å

jobs:
  security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          exit-code: "1"
          severity: "CRITICAL,HIGH"

  build-and-push:
    runs-on: ubuntu-latest
    needs: security-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push backend image
        working-directory: WeBlog_backend
        run: |
          # æ„å»ºåç«¯é•œåƒ
          docker build -f Dockerfile.prod -t ${{ env.DOCKER_USERNAME }}/weblog-backend:latest .

          # å¦‚æœæ˜¯releaseï¼Œæ·»åŠ ç‰ˆæœ¬æ ‡ç­¾
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION_TAG="${{ github.event.release.tag_name }}"
            docker tag ${{ env.DOCKER_USERNAME }}/weblog-backend:latest ${{ env.DOCKER_USERNAME }}/weblog-backend:${VERSION_TAG}
            docker push ${{ env.DOCKER_USERNAME }}/weblog-backend:${VERSION_TAG}
          fi

          # æ¨é€latestæ ‡ç­¾
          docker push ${{ env.DOCKER_USERNAME }}/weblog-backend:latest

  deploy:
    runs-on: ubuntu-latest
    environment: production
    needs: build-and-push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Select Terraform Workspace
        working-directory: terraform
        run: |
          terraform workspace select ${{ env.ENVIRONMENT }} || terraform workspace new ${{ env.ENVIRONMENT }}

      - name: Terraform Plan
        working-directory: terraform
        run: terraform plan -var-file="environments/${{ env.ENVIRONMENT }}.tfvars"

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -var-file="environments/${{ env.ENVIRONMENT }}.tfvars" -auto-approve

      - name: Deploy to EC2
        run: |
          # è·å–EC2å®ä¾‹ä¿¡æ¯
          cd terraform
          EC2_IP=$(terraform output -raw ec2_public_ip)

          # ç­‰å¾…EC2å®ä¾‹å®Œå…¨å¯åŠ¨
          echo "ç­‰å¾…EC2å®ä¾‹å¯åŠ¨å®Œæˆ..."
          sleep 120

          # è·å–æ•°æ®åº“ä¿¡æ¯
          DB_ENDPOINT=$(terraform output -raw rds_endpoint)
          DB_HOST=$(echo $DB_ENDPOINT | cut -d: -f1)
          DB_NAME=$(terraform output -raw database_name)
          DB_USERNAME=$(terraform output -raw database_username)
          DB_PASSWORD=$(terraform output -raw database_password)

          # SSHåˆ°EC2å®ä¾‹å¹¶é‡æ–°éƒ¨ç½²
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/weblog-prod-key.pem ec2-user@$EC2_IP << EOF
            cd /opt/weblog
            
            # è®¾ç½®ç¯å¢ƒå˜é‡
            export DB_HOST=$DB_HOST
            export DB_NAME=$DB_NAME
            export DB_USERNAME=$DB_USERNAME
            export DB_PASSWORD='$DB_PASSWORD'
            
            # åœæ­¢æ—§å®¹å™¨
            docker-compose -f docker-compose.prod.yml down
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            docker-compose -f docker-compose.prod.yml pull
            
            # å¯åŠ¨æ–°å®¹å™¨ï¼ˆæ˜ç¡®ä½¿ç”¨prod profileï¼‰
            docker-compose -f docker-compose.prod.yml up -d
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 30
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            docker-compose -f docker-compose.prod.yml ps
          EOF

      - name: Upload S3 and update CloudFront
        run: |
          # æ„å»ºå‰ç«¯
          cd WeBlog-frontend
          npm ci
          npm run build

          # è·å–S3æ¡¶å
          cd ../terraform
          S3_BUCKET=$(terraform output -raw s3_bucket_name)
          CLOUDFRONT_ID=$(terraform output -raw cloudfront_distribution_id)

          # ä¸Šä¼ åˆ°S3
          aws s3 sync ../WeBlog-frontend/dist/ s3://$S3_BUCKET --delete

          # æ¸…é™¤CloudFrontç¼“å­˜
          aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_ID --paths "/*"

      - name: Run health checks
        run: |
          cd terraform
          BACKEND_URL=$(terraform output -raw backend_url)
          FRONTEND_URL=$(terraform output -raw frontend_url)

          # æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
          for i in {1..10}; do
            if curl -f "$BACKEND_URL/actuator/health" > /dev/null 2>&1; then
              echo "âœ… åç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
              break
            fi
            echo "â³ ç­‰å¾…åç«¯å¯åŠ¨... ($i/10)"
            sleep 30
          done

          # æ£€æŸ¥å‰ç«¯
          for i in {1..10}; do
            if curl -f "$FRONTEND_URL" > /dev/null 2>&1; then
              echo "âœ… å‰ç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
              break
            fi
            echo "â³ ç­‰å¾…å‰ç«¯å‡†å¤‡å°±ç»ª... ($i/10)"
            sleep 30
          done

      - name: Create deployment summary
        run: |
          cd terraform
          BACKEND_URL=$(terraform output -raw backend_url)
          FRONTEND_URL=$(terraform output -raw frontend_url)

          echo "## ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "- **åç«¯API:** $BACKEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **å‰ç«¯åº”ç”¨:** $FRONTEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” å¥åº·æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- **åç«¯å¥åº·:** $BACKEND_URL/actuator/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š éƒ¨ç½²ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç¯å¢ƒ:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²æ—¶é—´:** $(date -u)" >> $GITHUB_STEP_SUMMARY
