name: ğŸš€ Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      environment:
        description: "éƒ¨ç½²ç¯å¢ƒ (dev/staging/prod)"
        required: false
        default: "dev"

env:
  # ç»Ÿä¸€ç¯å¢ƒæ§åˆ¶
  ENVIRONMENT: ${{ github.event.inputs.environment || 'prod' }}
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-west-2' }}
  S3_BUCKET: ${{ secrets.S3_BUCKET }}
  CLOUDFRONT_DOMAIN: ${{ secrets.CLOUDFRONT_DOMAIN }}
  # æ•°æ®åº“ä¸åº”ç”¨å¯†é’¥ï¼ˆè¯·åœ¨ Repo Secrets é…ç½®ä»¥ä¸‹å€¼ï¼›ä½¿ç”¨æ— ç¯å¢ƒå‰ç¼€çš„é€šç”¨å‘½åï¼‰
  DB_HOST: ${{ secrets.DB_HOST }}
  DB_NAME: ${{ secrets.DB_NAME }}
  DB_USERNAME: ${{ secrets.DB_USERNAME }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  JWT_SECRET: ${{ secrets.JWT_SECRET }}

jobs:
  # ======================================
  # æ„å»ºå’Œæ¨é€åç«¯Dockeré•œåƒ
  # ======================================
  deploy-backend:
    name: â˜• Deploy Backend
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: ğŸ—„ï¸ Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ”§ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Who am I (AWS caller identity)
        run: aws sts get-caller-identity | cat

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build and test backend
        working-directory: WeBlog_backend
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      - name: ğŸ³ Build and push Docker image
        working-directory: WeBlog_backend
        run: |
          # æ„å»ºå¤šæ ‡ç­¾é•œåƒ (ç§»é™¤æ—¶é—´æˆ³æ ‡ç­¾ï¼Œç®€åŒ–æµç¨‹)
          docker build -f Dockerfile \
            -t mx0100/weblog-backend:latest \
            -t mx0100/weblog-backend:${{ github.sha }} \
            .

          # æ¨é€æ‰€æœ‰æ ‡ç­¾
          docker push mx0100/weblog-backend:latest
          docker push mx0100/weblog-backend:${{ github.sha }}

      - name: ğŸ”„ Deploy to EC2 via SSM
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åç«¯åˆ°EC2..."

          # è·å–EC2å®ä¾‹ID
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=weblog-${{ env.ENVIRONMENT }}-web-server" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)

          echo "ğŸ“ ç›®æ ‡å®ä¾‹: $INSTANCE_ID"

          if [ "$INSTANCE_ID" = "None" ] || [ -z "$INSTANCE_ID" ]; then
            echo "âŒ æœªæ‰¾åˆ°åŒ¹é…çš„EC2å®ä¾‹ (tag: weblog-${{ env.ENVIRONMENT }}-web-server)"
            exit 1
          fi

          # é€šè¿‡SSMæ‰§è¡Œéƒ¨ç½²å‘½ä»¤ï¼šåœ¨EC2ä¸Šè§„èŒƒåŒ–docker-composeæ–‡ä»¶å¹¶æ³¨å…¥æœ€æ–°ç¯å¢ƒå˜é‡
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids $INSTANCE_ID \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "echo \"ğŸ”„ å¼€å§‹æ›´æ–°åº”ç”¨...\"",
              "cd /opt/weblog",
              "echo \"ğŸ“ ç”Ÿæˆæ ‡å‡†åŒ– docker-compose.prod.yml...\"",
              "bash -lc \"cat > docker-compose.prod.yml << 'EOF'\nversion: '3.8'\n\nservices:\n  weblog-backend:\n    image: mx0100/weblog-backend:latest\n    container_name: weblog-backend\n    ports:\n      - '8080:8080'\n    environment:\n      - SPRING_PROFILES_ACTIVE=prod\n      - DB_HOST=\\${DB_HOST}\n      - DB_NAME=\\${DB_NAME}\n      - DB_USERNAME=\\${DB_USERNAME}\n      - DB_PASSWORD=\\${DB_PASSWORD}\n      - JWT_SECRET=\\${JWT_SECRET}\n      - CORS_ORIGINS=\\${CORS_ORIGINS}\n      - JAVA_OPTS=-Xms256m -Xmx512m -Dspring.devtools.restart.enabled=false\n    restart: unless-stopped\n    healthcheck:\n      test: ['CMD', 'curl', '-f', 'http://localhost:8080/actuator/health']\n      interval: 30s\n      timeout: 10s\n      retries: 3\n      start_period: 60s\n    logging:\n      driver: 'awslogs'\n      options:\n        awslogs-group: '/aws/ec2/weblog-${{ env.ENVIRONMENT }}'\n        awslogs-region: '${{ env.AWS_REGION }}'\n        awslogs-stream: 'weblog-backend'\nEOF\"",
              "echo \"ğŸ”§ è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡...\"",
              "export DB_HOST=${{ env.DB_HOST }}",
              "export DB_NAME=${{ env.DB_NAME }}",
              "export DB_USERNAME=${{ env.DB_USERNAME }}",
              "export DB_PASSWORD=${{ env.DB_PASSWORD }}",
              "export JWT_SECRET=${{ env.JWT_SECRET }}",
              "export CORS_ORIGINS=https://${{ env.CLOUDFRONT_DOMAIN }}",
              "echo \"ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ...\"",
              "docker-compose -f docker-compose.prod.yml pull",
              "echo \"ğŸ”„ é‡å¯åº”ç”¨å®¹å™¨...\"",
              "docker-compose -f docker-compose.prod.yml up -d --force-recreate",
              "echo \"â³ ç­‰å¾…åº”ç”¨å¯åŠ¨...\"",
              "sleep 30",
              "echo \"âœ… åº”ç”¨æ›´æ–°å®Œæˆ\"",
              "docker ps | grep weblog-backend || true",
              "echo \"ğŸ” æ£€æŸ¥åº”ç”¨æ—¥å¿—...\"",
              "docker logs weblog-backend --tail 50 2>&1 || echo No logs available"
            ]' \
            --query "Command.CommandId" \
            --output text)

          echo "ğŸ“ å‘½ä»¤ID: $COMMAND_ID"

          # ç­‰å¾…å‘½ä»¤æ‰§è¡Œå®Œæˆ
          echo "â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
          aws ssm wait command-executed \
            --command-id $COMMAND_ID \
            --instance-id $INSTANCE_ID

          # è·å–æ‰§è¡Œç»“æœ
          aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id $INSTANCE_ID \
            --query "StandardOutputContent" \
            --output text

          echo "ğŸ‰ åç«¯éƒ¨ç½²å®Œæˆï¼"

  # ======================================
  # æ„å»ºå’Œéƒ¨ç½²å‰ç«¯åˆ°S3
  # ======================================
  deploy-frontend:
    name: ğŸŒ Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-backend
    # åªæœ‰åœ¨åç«¯éƒ¨ç½²æˆåŠŸæ—¶æ‰è¿è¡Œå‰ç«¯éƒ¨ç½²
    if: success()

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: WeBlog-frontend/package-lock.json

      - name: ğŸ”§ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Who am I (AWS caller identity)
        run: aws sts get-caller-identity | cat

      - name: ğŸ“¦ Install dependencies
        working-directory: WeBlog-frontend
        run: npm ci

      - name: ğŸ—ï¸ Build frontend for production
        working-directory: WeBlog-frontend
        env:
          VITE_API_BASE_URL: https://${{ env.CLOUDFRONT_DOMAIN }}
          VITE_WS_URL: wss://${{ env.CLOUDFRONT_DOMAIN }}/ws
          VITE_ENV_NAME: production
        run: |
          echo "ğŸ—ï¸ æ„å»ºç”Ÿäº§ç¯å¢ƒå‰ç«¯..."
          echo "APIåœ°å€: $VITE_API_BASE_URL"
          echo "WebSocketåœ°å€: $VITE_WS_URL"
          npm run build

      - name: ğŸš€ Deploy to S3
        working-directory: WeBlog-frontend
        run: |
          echo "ğŸ“¤ ä¸Šä¼ å‰ç«¯æ–‡ä»¶åˆ°S3..."
          if [ -z "${{ env.S3_BUCKET }}" ]; then echo "âŒ S3_BUCKET æœªé…ç½®ä¸ºä»“åº“æœºå¯†"; exit 1; fi
          aws s3 sync dist/ s3://${{ env.S3_BUCKET }}/ \
            --delete \
            --cache-control "public,max-age=31536000" \
            --exclude "*.html" \
            --exclude "*.json"

          # HTMLæ–‡ä»¶å•ç‹¬å¤„ç†ï¼ˆä¸ç¼“å­˜ï¼‰
          aws s3 sync dist/ s3://${{ env.S3_BUCKET }}/ \
            --cache-control "no-cache" \
            --include "*.html" \
            --include "*.json"

          echo "âœ… å‰ç«¯æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼"

      - name: ğŸ”„ Invalidate CloudFront cache
        run: |
          echo "ğŸ”„ æ¸…é™¤CloudFrontç¼“å­˜..."
          if [ -z "${{ env.CLOUDFRONT_DOMAIN }}" ]; then echo "âŒ CLOUDFRONT_DOMAIN æœªé…ç½®ä¸ºä»“åº“æœºå¯†"; exit 1; fi
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?DomainName=='${{ env.CLOUDFRONT_DOMAIN }}'].Id | [0]" \
            --output text)

          if [ "$DISTRIBUTION_ID" != "None" ] && [ "$DISTRIBUTION_ID" != "" ]; then
            INVALIDATION_ID=$(aws cloudfront create-invalidation \
              --distribution-id $DISTRIBUTION_ID \
              --paths "/*" \
              --query "Invalidation.Id" \
              --output text)
            
            echo "ğŸ”„ ç¼“å­˜æ¸…é™¤ID: $INVALIDATION_ID"
            echo "âœ… CloudFrontç¼“å­˜æ¸…é™¤å®Œæˆï¼"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°CloudFrontåˆ†å‘"
          fi

  # ======================================
  # å¥åº·æ£€æŸ¥å’ŒéªŒè¯
  # ======================================
  health-check:
    name: ğŸ” Health Check
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    # åªæœ‰åœ¨å‰ç«¯å’Œåç«¯éƒ½æˆåŠŸæ—¶æ‰è¿è¡Œå¥åº·æ£€æŸ¥
    if: success()

    steps:
      - name: â³ Wait for deployment stabilization
        run: |
          echo "â³ ç­‰å¾…éƒ¨ç½²ç¨³å®šï¼ˆ60ç§’ï¼‰..."
          sleep 60

      - name: ğŸ” Check backend health
        run: |
          echo "ğŸ” æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€..."
          BACKEND_URL="https://${{ env.CLOUDFRONT_DOMAIN }}/actuator/health"

          for i in {1..10}; do
            echo "ğŸ” å¥åº·æ£€æŸ¥å°è¯• $i/10..."
            
            if curl -f -s $BACKEND_URL | grep -q "UP"; then
              echo "âœ… åç«¯å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
              (curl -s $BACKEND_URL | jq '.' ) || curl -s $BACKEND_URL || true
              break
            fi
            
            if [ $i -eq 10 ]; then
              echo "âŒ åç«¯å¥åº·æ£€æŸ¥å¤±è´¥"
              exit 1
            fi
            
            echo "â³ ç­‰å¾…30ç§’åé‡è¯•..."
            sleep 30
          done

      - name: ğŸ” Check frontend accessibility
        run: |
          echo "ğŸ” æ£€æŸ¥å‰ç«¯å¯è®¿é—®æ€§..."
          FRONTEND_URL="https://${{ env.CLOUDFRONT_DOMAIN }}"

          if curl -f -s $FRONTEND_URL > /dev/null; then
            echo "âœ… å‰ç«¯è®¿é—®æ­£å¸¸ï¼"
            echo "ğŸŒ å‰ç«¯åœ°å€: $FRONTEND_URL"
          else
            echo "âŒ å‰ç«¯è®¿é—®å¤±è´¥"
            exit 1
          fi

      - name: ğŸ‰ Deployment summary
        run: |
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆæ‘˜è¦ï¼š"
          echo "================================"
          echo "ğŸŒ å‰ç«¯åœ°å€: https://${{ env.CLOUDFRONT_DOMAIN }}"
          echo "ğŸ”§ åç«¯API: https://${{ env.CLOUDFRONT_DOMAIN }}/api"
          echo "ğŸ’“ å¥åº·æ£€æŸ¥: https://${{ env.CLOUDFRONT_DOMAIN }}/actuator/health"
          echo "ğŸ”Œ WebSocket: wss://${{ env.CLOUDFRONT_DOMAIN }}/ws/notifications"
          echo "ğŸš€ éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸ“ Gitæäº¤: ${{ github.sha }}"
          echo "================================"
          echo "âœ… æ‰€æœ‰æœåŠ¡è¿è¡Œæ­£å¸¸ï¼"

  # ======================================
  # é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
  # ======================================
  notify:
    name: ğŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend, health-check]
    if: always()

    steps:
      - name: ğŸ“¢ Deployment notification
        run: |
          # æ£€æŸ¥æ‰€æœ‰å…³é”®æ­¥éª¤çš„çŠ¶æ€
          BACKEND_STATUS="${{ needs.deploy-backend.result }}"
          FRONTEND_STATUS="${{ needs.deploy-frontend.result }}"
          HEALTH_STATUS="${{ needs.health-check.result }}"

          echo "ğŸ” éƒ¨ç½²çŠ¶æ€æ£€æŸ¥ï¼š"
          echo "åç«¯éƒ¨ç½²: $BACKEND_STATUS"
          echo "å‰ç«¯éƒ¨ç½²: $FRONTEND_STATUS"  
          echo "å¥åº·æ£€æŸ¥: $HEALTH_STATUS"

          # å¦‚æœæ‰€æœ‰å…³é”®æ­¥éª¤éƒ½æˆåŠŸ
          if [ "$BACKEND_STATUS" == "success" ] && [ "$FRONTEND_STATUS" == "success" ] && [ "$HEALTH_STATUS" == "success" ]; then
            echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ åº”ç”¨åœ°å€: https://${{ env.CLOUDFRONT_DOMAIN }}"
            echo "â° éƒ¨ç½²æ—¶é—´: $(date)"
            echo "ğŸ“ Gitæäº¤: ${{ github.sha }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯¦ç»†ä¿¡æ¯ï¼š"
            echo "  - åç«¯éƒ¨ç½²çŠ¶æ€: $BACKEND_STATUS"
            echo "  - å‰ç«¯éƒ¨ç½²çŠ¶æ€: $FRONTEND_STATUS"
            echo "  - å¥åº·æ£€æŸ¥çŠ¶æ€: $HEALTH_STATUS"
            echo ""
            echo "è¯·æ£€æŸ¥å¤±è´¥çš„æ­¥éª¤æ—¥å¿—è¿›è¡Œæ’æŸ¥"
            exit 1
          fi
